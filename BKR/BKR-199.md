# BKR-199: Malicious actors can exploit user-approved allowances on VaultRouter to drain their ERC20 tokens - F18

## 问题概述

**BKR-199** 是一个严重的安全漏洞，属于**模糊测试发现的安全问题**（F18）。该漏洞允许恶意攻击者利用用户在VaultRouter上已授权的allowance来耗尽用户的ERC20代币。

## 问题类型

- **类型**: 安全漏洞
- **严重程度**: 高
- **发现方式**: 模糊测试 (F18)
- **影响**: 用户资产损失

## 漏洞详情

### 问题描述

在`b-pre-mitigation`版本中，VaultRouter的`_handlePullTokenFrom`和`_handlePushTokenFrom`函数存在严重的安全漏洞：

1. **缺少授权检查**: 这些函数没有验证`from`参数是否等于`msg.sender`
2. **恶意利用**: 攻击者可以构造交易，指定任意用户地址作为`from`参数
3. **资产耗尽**: 如果目标用户之前授权了VaultRouter足够的allowance，攻击者就可以转移用户的代币

### 漏洞代码分析

#### b-pre-mitigation (81485a9) - 存在漏洞的代码

```solidity
function _handlePullTokenFrom(
  bytes calldata data,
  uint256[] memory callStack,
  uint32 inputMapping
) private returns (bytes memory) {
  IERC20 token;
  address from;
  uint256 amount;
  assembly {
    token := calldataload(data.offset)
    from := calldataload(add(data.offset, 0x20))
    amount := calldataload(add(data.offset, 0x40))
  }
  amount = Commands.pullInputParam(callStack, amount, inputMapping, 1);
  pullTokenFrom(token, from, amount);  // 没有检查 from != msg.sender
  return "";
}

function _handlePushTokenFrom(
  bytes calldata data,
  uint256[] memory callStack,
  uint32 inputMapping
) private returns (bytes memory) {
  IERC20 token;
  address from;
  address to;
  uint256 amount;
  assembly {
    token := calldataload(data.offset)
    from := calldataload(add(data.offset, 0x20))
    to := calldataload(add(data.offset, 0x40))
    amount := calldataload(add(data.offset, 0x60))
  }
  amount = Commands.pullInputParam(callStack, amount, inputMapping, 1);
  pushTokenFrom(token, from, to, amount);  // 没有检查 from != msg.sender
  return "";
}
```

#### 攻击场景

1. 用户A授权VaultRouter合约转移其USDC代币（例如1000 USDC）
2. 攻击者B调用`_handlePullTokenFrom`，指定`from`参数为用户A的地址
3. 由于用户A已经授权，VaultRouter可以成功转移用户A的代币
4. 攻击者B获得用户A的代币，造成用户A的资产损失

## 修复方案

### b-post-mitigation (f99edb1) - 修复后的代码

```solidity
function _handlePullTokenFrom(
  bytes calldata data,
  uint256[] memory callStack,
  uint32 inputMapping
) private returns (bytes memory) {
  IERC20 token;
  address from;
  uint256 amount;
  assembly {
    token := calldataload(data.offset)
    from := calldataload(add(data.offset, 0x20))
    amount := calldataload(add(data.offset, 0x40))
  }
  if (from != msg.sender) revert NotAuthorized();  // 添加授权检查
  
  amount = Commands.pullInputParam(callStack, amount, inputMapping, 1);
  pullTokenFrom(token, from, amount);
  return "";
}

function _handlePushTokenFrom(
  bytes calldata data,
  uint256[] memory callStack,
  uint32 inputMapping
) private returns (bytes memory) {
  IERC20 token;
  address from;
  address to;
  uint256 amount;
  assembly {
    token := calldataload(data.offset)
    from := calldataload(add(data.offset, 0x20))
    to := calldataload(add(data.offset, 0x40))
    amount := calldataload(add(data.offset, 0x60))
  }
  if (from != msg.sender) revert NotAuthorized();  // 添加授权检查
  
  amount = Commands.pullInputParam(callStack, amount, inputMapping, 1);
  pushTokenFrom(token, from, to, amount);
  return "";
}
```

### 修复要点

1. **添加授权检查**: 在`_handlePullTokenFrom`和`_handlePushTokenFrom`函数中添加`if (from != msg.sender) revert NotAuthorized();`
2. **自定义错误**: 引入`NotAuthorized()`错误类型，提供更清晰的错误信息
3. **防止恶意利用**: 确保只有代币的实际拥有者才能授权VaultRouter转移其代币

## 其他相关修复

### 移除未使用的代码

```solidity
// 移除了未使用的UsePermitTransfers导入
- import { UsePermitTransfers } from "./hooks/UsePermitTransfers.sol";

// 移除了未使用的_approvedSwapTokens映射
- mapping(IERC20 => bool) private _approvedSwapTokens;

// 移除了PULL_TOKEN_WITH_PERMIT命令处理
- } else if (actionToExecute == Commands.PULL_TOKEN_WITH_PERMIT) {
-   output = _handlePullTokenWithPermit(data, callStack, inputMapping);
```

### 添加新功能

```solidity
// 添加了SWEEP_NATIVE命令支持
+ } else if (actionToExecute == Commands.SWEEP_NATIVE) {
+   output = _handleSweepNative(data, callStack, outputMapping);

// 添加了_handleSweepNative函数
+ function _handleSweepNative(
+   bytes calldata data,
+   uint256[] memory callStack,
+   uint32 outputMapping
+ ) private returns (bytes memory) {
+   // 实现原生代币清扫功能
+ }
```

## 安全影响

### 修复前 (b-pre-mitigation)
- **高风险**: 攻击者可以耗尽用户的ERC20代币
- **影响范围**: 所有使用VaultRouter的用户
- **攻击成本**: 极低，只需要构造恶意交易

### 修复后 (b-post-mitigation)
- **安全**: 只有代币拥有者才能授权转移
- **防护**: 通过授权检查防止恶意利用
- **用户体验**: 保持正常功能的同时确保安全性

## 总结

BKR-199是一个通过模糊测试发现的高危安全漏洞，涉及VaultRouter的授权机制。修复方案通过添加`from != msg.sender`检查，确保只有代币的实际拥有者才能授权VaultRouter转移其代币，有效防止了恶意攻击者利用用户已授权的allowance来耗尽用户资产。

这个修复不仅解决了安全漏洞，还清理了未使用的代码，并添加了新的功能，体现了代码质量的全面提升。
