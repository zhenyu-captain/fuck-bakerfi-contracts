# CK-209/F11 分析报告

## 基本信息
- **编号**: CK-209/F11
- **标题**: The _handleSweepTokens function lacks the ability to withdraw native ETH
- **发现时间**: 2025-01-15
- **修复时间**: 2025-02-05 (f99edb1)
- **性质**: **安全漏洞** (通过Cantina外部审计发现)
- **严重程度**: **中** - 影响原生ETH管理功能

## 漏洞描述
CK-209/F11 是一个功能缺失漏洞，涉及_handleSweepTokens函数缺乏提取原生ETH的能力。该漏洞通过Cantina外部审计发现，限制了VaultRouter对原生ETH的管理能力，可能影响资金回收和紧急情况处理。

## 版本对比分析

### b-pre-mitigation (81485a9) - 漏洞存在状态
**关键发现**: b-pre-mitigation版本中_handleSweepTokens函数**只能处理ERC20代币，无法提取原生ETH**

#### 漏洞存在
- ❌ **缺少SWEEP_NATIVE命令**: Commands.sol中没有SWEEP_NATIVE常量
- ❌ **缺少_handleSweepNative函数**: VaultRouter.sol中没有处理原生ETH提取的函数
- ❌ **缺少sweepNative函数**: UseTokenActions.sol中没有原生ETH提取功能
- ❌ **功能不完整**: 无法通过VaultRouter提取合约中的原生ETH

#### 81485a9中的问题代码
```solidity
// Commands.sol - 缺少SWEEP_NATIVE命令
uint8 public constant SWEEP_TOKENS = 0x06; // Command to sweep tokens from the contract.
uint8 public constant WRAP_ETH = 0x07; // Command to wrap ETH into WETH.
uint8 public constant UNWRAP_ETH = 0x08; // Command to unwrap WETH back into ETH.
// ❌ 缺少 SWEEP_NATIVE = 0x0B;

// VaultRouter.sol - 缺少_handleSweepNative函数
function _handleSweepTokens(
  bytes calldata data,
  uint256[] memory callStack,
  uint32 outputMapping
) private returns (bytes memory) {
  IERC20 token;
  address to;
  assembly {
    token := calldataload(data.offset)
    to := calldataload(add(data.offset, 0x20))
  }
  uint256 sweptAmount = sweepTokens(token, to);  // ❌ 只能处理ERC20代币
  Commands.pushOutputParam(callStack, sweptAmount, outputMapping, 1);
  return abi.encodePacked(sweptAmount);
}
// ❌ 缺少 _handleSweepNative 函数

// UseTokenActions.sol - 缺少sweepNative函数
function sweepTokens(IERC20 token, address to) internal virtual returns (uint256 sweptAmount) {
  if (address(token) == address(0)) revert InvalidToken();
  if (address(to) == address(0)) revert InvalidRecipient();
  sweptAmount = IERC20(token).balanceOf(address(this));
  IERC20(token).safeTransfer(to, sweptAmount);  // ❌ 只能处理ERC20代币
}
// ❌ 缺少 sweepNative 函数
```

### b-post-mitigation (f99edb1) - 修复后状态
**关键发现**: b-post-mitigation版本中**新增了完整的原生ETH提取功能**

#### 修复后的实现
- ✅ **新增SWEEP_NATIVE命令**: Commands.sol中添加了SWEEP_NATIVE常量
- ✅ **新增_handleSweepNative函数**: VaultRouter.sol中添加了处理原生ETH提取的函数
- ✅ **新增sweepNative函数**: UseTokenActions.sol中添加了原生ETH提取功能
- ✅ **功能完整**: 可以通过VaultRouter提取合约中的原生ETH

#### f99edb1中的修复代码
```solidity
// Commands.sol - 新增SWEEP_NATIVE命令
uint8 public constant SWEEP_TOKENS = 0x06; // Command to sweep tokens from the contract.
uint8 public constant WRAP_ETH = 0x07; // Command to wrap ETH into WETH.
uint8 public constant UNWRAP_ETH = 0x08; // Command to unwrap WETH back into ETH.
uint8 public constant SEND_NATIVE = 0x0A; // Command to send native tokens to a specified address.
uint8 public constant SWEEP_NATIVE = 0x0B; // ✅ 新增原生ETH提取命令

// VaultRouter.sol - 新增_handleSweepNative函数
function _handleSweepNative(
  bytes calldata data,
  uint256[] memory callStack,
  uint32 outputMapping
) private returns (bytes memory) {
  address to;
  assembly {
    to := calldataload(data.offset)
  }
  uint256 sweptAmount = sweepNative(to);  // ✅ 处理原生ETH提取
  Commands.pushOutputParam(callStack, sweptAmount, outputMapping, 1);
  return abi.encodePacked(sweptAmount);
}

// UseTokenActions.sol - 新增sweepNative函数
function sweepNative(address to) internal virtual returns (uint256 sweptAmount) {
  if (address(to) == address(0)) revert InvalidRecipient();
  sweptAmount = address(this).balance;
  if (sweptAmount > 0) {
    (bool success, ) = payable(to).call{ value: sweptAmount }("");
    if (!success) revert SweepFailed();  // ✅ 处理原生ETH提取
  }
  return sweptAmount;
}
```

#### VaultRouter命令处理更新
```solidity
// VaultRouter.sol - 更新命令处理逻辑
if (actionToExecute == Commands.SWEEP_TOKENS) {
  output = _handleSweepTokens(data, callStack, outputMapping);
} else if (actionToExecute == Commands.SWEEP_NATIVE) {  // ✅ 新增原生ETH处理
  output = _handleSweepNative(data, callStack, outputMapping);
} else if (actionToExecute == Commands.WRAP_ETH) {
  output = _handleWrapETH(data, callStack, inputMapping);
}
```

## 漏洞机制分析

### 漏洞根因
CK-209/F11的漏洞根因在于**功能实现不完整**：

1. **命令缺失**: 缺少SWEEP_NATIVE命令定义
2. **处理函数缺失**: 缺少_handleSweepNative处理函数
3. **底层功能缺失**: 缺少sweepNative底层实现
4. **功能不统一**: ERC20代币和原生ETH处理不一致

### 潜在风险
1. **资金回收困难**: 无法通过VaultRouter提取合约中的原生ETH
2. **紧急处理受限**: 紧急情况下无法快速回收原生ETH
3. **功能不完整**: 与ERC20代币处理功能不一致
4. **用户体验差**: 用户无法通过统一接口管理所有资产

## 修复方案 (f99edb1)

### 1. 新增SWEEP_NATIVE命令
- **Commands.sol**: 添加`SWEEP_NATIVE = 0x0B`常量
- **命令定义**: 定义原生ETH提取命令标识符
- **文档更新**: 更新命令说明文档

### 2. 实现_handleSweepNative函数
- **VaultRouter.sol**: 添加原生ETH提取处理函数
- **参数解析**: 解析目标地址参数
- **结果处理**: 处理提取结果并返回

### 3. 实现sweepNative底层功能
- **UseTokenActions.sol**: 添加原生ETH提取底层实现
- **安全检查**: 验证目标地址有效性
- **转账处理**: 使用call方式转账原生ETH
- **错误处理**: 添加转账失败处理

### 4. 更新命令处理逻辑
- **VaultRouter.sol**: 在命令分发中添加SWEEP_NATIVE处理
- **测试更新**: 添加原生ETH提取测试用例
- **接口统一**: 确保所有资产类型都有对应的提取功能

## 影响评估

### 修复前 (b-pre-mitigation)
- **功能缺失**: 无法通过VaultRouter提取原生ETH
- **资金管理受限**: 原生ETH可能被困在合约中
- **紧急处理困难**: 紧急情况下无法快速回收原生ETH
- **功能不统一**: ERC20和原生ETH处理不一致

### 修复后 (b-post-mitigation)
- **功能完整**: 可以通过VaultRouter提取原生ETH
- **资金管理完善**: 支持所有资产类型的提取
- **紧急处理便利**: 紧急情况下可以快速回收所有资产
- **功能统一**: ERC20和原生ETH处理一致

## 测试验证

### 原生ETH提取测试
```typescript
it('test__sweepNative', async function () {
  const { useTokenActions, owner, otherAccount } = await deployFunction();
  const useTokenActionsAddress = await useTokenActions.getAddress();
  
  // 发送10 ETH到合约
  await owner.sendTransaction({
    to: useTokenActionsAddress,
    value: ethers.parseEther('10'),
  });
  
  expect(await ethers.provider.getBalance(useTokenActionsAddress)).to.equal(
    ethers.parseEther('10'),
  );
  
  // 测试原生ETH提取
  await expect(useTokenActions.test__sweepNative(otherAccount.address)).to.changeEtherBalances(
    [useTokenActionsAddress, otherAccount.address],
    [ethers.parseEther('-10'), ethers.parseEther('10')],
  );
});
```

### 功能完整性测试
- ✅ 原生ETH提取功能正常工作
- ✅ ERC20代币提取功能保持不变
- ✅ 所有资产类型都有对应的提取功能
- ✅ 错误处理机制正常工作

## 结论

CK-209/F11是一个**功能实现不完整导致的功能缺失漏洞**，通过Cantina外部审计发现。b-pre-mitigation版本中_handleSweepTokens函数只能处理ERC20代币，无法提取原生ETH，影响了VaultRouter的完整性和资金管理能力。

修复通过新增SWEEP_NATIVE命令、_handleSweepNative处理函数和sweepNative底层实现，完善了VaultRouter的功能，使其能够统一处理ERC20代币和原生ETH，提高了资金管理的完整性和便利性。

## 相关文件
- `contracts/core/router/Commands.sol` (修复)
- `contracts/core/VaultRouter.sol` (修复)
- `contracts/core/hooks/UseTokenActions.sol` (修复)
- `test/hooks/UseTokenActions.test.ts` (测试)
