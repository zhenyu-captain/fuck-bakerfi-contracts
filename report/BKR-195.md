# BKR-195 åˆ†ææŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯
- **ç¼–å·**: BKR-195
- **æ ‡é¢˜**: _deployedAmount not updated on StrategySupplyBase.undeploy, preventing performance fees from being collected - F6
- **å‘ç°æ—¶é—´**: 2025-01-09
- **ä¿®å¤æ—¶é—´**: 2025-01-09 (f99edb1)
- **æ€§è´¨**: **å®‰å…¨æ¼æ´** (é€šè¿‡æ¨¡ç³Šæµ‹è¯•F6å‘ç°)
- **ä¸¥é‡ç¨‹åº¦**: **é«˜** - å½±å“æ€§èƒ½è´¹ç”¨æ”¶é›†

## æ¼æ´æè¿°
BKR-195 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œåœ¨StrategySupplyBase.undeployå‡½æ•°ä¸­ï¼Œ`_deployedAmount`çŠ¶æ€å˜é‡æ²¡æœ‰æ­£ç¡®æ›´æ–°ï¼Œå¯¼è‡´æ€§èƒ½è´¹ç”¨æ— æ³•æ­£ç¡®è®¡ç®—å’Œæ”¶é›†ã€‚

## åœ¨81485a9ä¸­çš„æ¼æ´çŠ¶æ€
### æ¼æ´ä½ç½®
åœ¨ `b-pre-mitigation (81485a9)` ç‰ˆæœ¬ä¸­ï¼ŒStrategySupplyAAVEv3.solçš„undeployå‡½æ•°å­˜åœ¨æ¼æ´ï¼š

```solidity
// 81485a9ç‰ˆæœ¬ä¸­çš„æ¼æ´ä»£ç 
function undeploy(uint256 amount) external nonReentrant onlyOwner returns (uint256 undeployedAmount) {
  if (amount == 0) revert ZeroAmount();
  
  // Get Balance
  uint256 balance = getBalance();
  if (amount > balance) revert InsufficientBalance();
  
  // Transfer assets back to caller
  uint256 withdrawalValue = _aavev3.withdraw(_asset, amount, address(this));
  
  // Check withdrawal value matches the initial amount
  if (withdrawalValue != amount) revert WithdrawalValueMismatch();
  
  // Transfer assets to user
  ERC20(_asset).safeTransfer(msg.sender, amount);
  
  balance -= amount;
  emit StrategyUndeploy(msg.sender, amount);
  emit StrategyAmountUpdate(balance);
  
  return amount;
  // âŒ ç¼ºå°‘: _deployedAmount -= withdrawalValue;
}
```

### æ¼æ´å½±å“
1. **æ€§èƒ½è´¹ç”¨è®¡ç®—é”™è¯¯**: `_deployedAmount`æ²¡æœ‰å‡å°‘ï¼Œå¯¼è‡´æ€§èƒ½è´¹ç”¨è®¡ç®—åŸºäºé”™è¯¯çš„åŸºæ•°
2. **çŠ¶æ€ä¸ä¸€è‡´**: å†…éƒ¨çŠ¶æ€ä¸å®é™…éƒ¨ç½²é‡‘é¢ä¸åŒ¹é…
3. **è´¹ç”¨æ”¶é›†é—®é¢˜**: å¯èƒ½å¯¼è‡´æ€§èƒ½è´¹ç”¨æ— æ³•æ­£ç¡®æ”¶é›†
4. **ä¼šè®¡é”™è¯¯**: ç­–ç•¥çš„è´¦é¢ä»·å€¼ä¸å®é™…ä»·å€¼ä¸ç¬¦

### æ¼æ´æ ¹å› 
- **çŠ¶æ€æ›´æ–°ç¼ºå¤±**: undeployå‡½æ•°æ²¡æœ‰æ›´æ–°`_deployedAmount`çŠ¶æ€å˜é‡
- **è®¾è®¡ç¼ºé™·**: åœ¨æå–èµ„äº§åæ²¡æœ‰ç›¸åº”å‡å°‘å·²éƒ¨ç½²é‡‘é¢çš„è·Ÿè¸ª

## ä¿®å¤æ–¹æ¡ˆ (f99edb1)
### 1. åˆ›å»ºStrategySupplyBaseåŸºç±»
- **æ–°å¢æ–‡ä»¶**: `contracts/core/strategies/StrategySupplyBase.sol`
- **åŠŸèƒ½**: æä¾›ä¾›åº”ç­–ç•¥çš„é€šç”¨åŸºç±»ï¼ŒåŒ…å«æ­£ç¡®çš„çŠ¶æ€ç®¡ç†

### 2. ä¿®å¤undeployå‡½æ•°
```solidity
// ä¿®å¤åçš„ä»£ç  (f99edb1)
function undeploy(uint256 amount) external nonReentrant onlyOwner returns (uint256 undeployedAmount) {
  if (amount == 0) revert ZeroAmount();
  
  // Get Balance
  uint256 balance = getBalance();
  if (amount > balance) revert InsufficientBalance();
  
  // Transfer assets back to caller
  uint256 withdrawalValue = _undeploy(amount);
  
  // âœ… ä¿®å¤: Update the deployed amount
  _deployedAmount -= withdrawalValue;
  
  // Check withdrawal value matches the initial amount
  // Transfer assets to user
  ERC20(_asset).safeTransfer(msg.sender, withdrawalValue);
  
  balance -= withdrawalValue;
  emit StrategyUndeploy(msg.sender, withdrawalValue);
  emit StrategyAmountUpdate(balance);
  
  return withdrawalValue;
}
```

### 3. é‡æ„StrategySupplyAAVEv3
- **æ”¹è¿›**: ä»ç‹¬ç«‹å®ç°æ”¹ä¸ºç»§æ‰¿StrategySupplyBase
- **ä¿®å¤**: ä½¿ç”¨åŸºç±»çš„æ­£ç¡®çŠ¶æ€ç®¡ç†
- **ç»Ÿä¸€**: ä¸å…¶ä»–ä¾›åº”ç­–ç•¥ä¿æŒä¸€è‡´çš„æ¶æ„

## ä¿®å¤æäº¤è¯¦æƒ…
- **æäº¤å“ˆå¸Œ**: 1662f58
- **PR**: #12
- **ä½œè€…**: Chef Kenji, thesilph
- **æ–‡ä»¶å˜æ›´**: 1ä¸ªæ–‡ä»¶ï¼Œ+3è¡Œ

### å…·ä½“ä¿®å¤
```diff
// Transfer assets back to caller
uint256 withdrawalValue = _undeploy(amount);

+// Update the deployed amount
+_deployedAmount -= withdrawalValue;

// Check withdrawal value matches the initial amount
// Transfer assets to user
ERC20(_asset).safeTransfer(msg.sender, withdrawalValue);
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æ¼æ´æœºåˆ¶åˆ†æ
```solidity
// æ¼æ´åœºæ™¯ç¤ºä¾‹
// 1. ç”¨æˆ·éƒ¨ç½² 1000 USDC
_deployedAmount = 1000;

// 2. ç”¨æˆ·æå– 500 USDC
// âŒ æ¼æ´: _deployedAmount ä»ç„¶æ˜¯ 1000
// æ­£ç¡®åº”è¯¥æ˜¯: _deployedAmount = 500

// 3. æ€§èƒ½è´¹ç”¨è®¡ç®—
// âŒ é”™è¯¯: åŸºäº 1000 USDC è®¡ç®—è´¹ç”¨
// æ­£ç¡®: åº”è¯¥åŸºäº 500 USDC è®¡ç®—è´¹ç”¨
```

### ä¿®å¤åçš„æ­£ç¡®æµç¨‹
```solidity
// ä¿®å¤åçš„æ­£ç¡®æµç¨‹
// 1. ç”¨æˆ·éƒ¨ç½² 1000 USDC
_deployedAmount = 1000;

// 2. ç”¨æˆ·æå– 500 USDC
_deployedAmount -= 500; // âœ… æ­£ç¡®æ›´æ–°
_deployedAmount = 500;

// 3. æ€§èƒ½è´¹ç”¨è®¡ç®—
// âœ… æ­£ç¡®: åŸºäº 500 USDC è®¡ç®—è´¹ç”¨
```

## å½±å“è¯„ä¼°
### å®‰å…¨é£é™©
- ğŸ”´ **é«˜ä¸¥é‡æ€§**: å½±å“æ€§èƒ½è´¹ç”¨æ”¶é›†æœºåˆ¶
- ğŸ”´ **è´¢åŠ¡å½±å“**: å¯èƒ½å¯¼è‡´è´¹ç”¨è®¡ç®—é”™è¯¯
- ğŸ”´ **çŠ¶æ€ä¸ä¸€è‡´**: å†…éƒ¨çŠ¶æ€ä¸å®é™…çŠ¶æ€ä¸åŒ¹é…
- ğŸ”´ **ç”¨æˆ·æŸå¤±**: å¯èƒ½å½±å“ç”¨æˆ·çš„æ”¶ç›Šè®¡ç®—

### ä¿®å¤æ•ˆæœ
- âœ… **çŠ¶æ€ä¸€è‡´æ€§**: æ­£ç¡®æ›´æ–°`_deployedAmount`
- âœ… **è´¹ç”¨è®¡ç®—**: æ€§èƒ½è´¹ç”¨åŸºäºæ­£ç¡®çš„åŸºæ•°è®¡ç®—
- âœ… **ä¼šè®¡å‡†ç¡®æ€§**: ç­–ç•¥è´¦é¢ä»·å€¼ä¸å®é™…ä»·å€¼ä¸€è‡´
- âœ… **æ¶æ„æ”¹è¿›**: é€šè¿‡åŸºç±»ç»Ÿä¸€çŠ¶æ€ç®¡ç†

## æµ‹è¯•éªŒè¯
### æ¨¡ç³Šæµ‹è¯•å‘ç°
- **æµ‹è¯•å·¥å…·**: F6 (æ¨¡ç³Šæµ‹è¯•)
- **å‘ç°æ–¹å¼**: é€šè¿‡éšæœºè¾“å…¥å‘ç°çŠ¶æ€ä¸ä¸€è‡´
- **æµ‹è¯•åœºæ™¯**: å¤šæ¬¡éƒ¨ç½²å’Œæå–æ“ä½œ

### ä¿®å¤éªŒè¯
```solidity
// æµ‹è¯•ç”¨ä¾‹
function testUndeployUpdatesDeployedAmount() public {
  // 1. éƒ¨ç½²èµ„äº§
  strategy.deploy(1000);
  assertEq(strategy.deployedAmount(), 1000);
  
  // 2. æå–èµ„äº§
  strategy.undeploy(500);
  assertEq(strategy.deployedAmount(), 500); // âœ… ä¿®å¤åé€šè¿‡
  
  // 3. éªŒè¯æ€§èƒ½è´¹ç”¨è®¡ç®—
  // åº”è¯¥åŸºäº 500 è€Œä¸æ˜¯ 1000 è®¡ç®—
}
```

## ç»“è®º
BKR-195 æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„å®‰å…¨æ¼æ´**ï¼Œé€šè¿‡æ¨¡ç³Šæµ‹è¯•F6å‘ç°ã€‚å®ƒå½±å“æ€§èƒ½è´¹ç”¨çš„æ­£ç¡®è®¡ç®—å’Œæ”¶é›†ï¼Œå¯èƒ½å¯¼è‡´è´¢åŠ¡æŸå¤±ã€‚ä¿®å¤é€šè¿‡æ­£ç¡®æ›´æ–°`_deployedAmount`çŠ¶æ€å˜é‡ï¼Œç¡®ä¿äº†çŠ¶æ€ä¸€è‡´æ€§å’Œè´¹ç”¨è®¡ç®—çš„å‡†ç¡®æ€§ã€‚

è¿™ä¸ªæ¼æ´çš„ä¿®å¤ä½“ç°äº†ï¼š
1. **çŠ¶æ€ç®¡ç†çš„é‡è¦æ€§**: å¿…é¡»æ­£ç¡®ç»´æŠ¤å†…éƒ¨çŠ¶æ€
2. **æµ‹è¯•çš„ä»·å€¼**: æ¨¡ç³Šæµ‹è¯•èƒ½å¤Ÿå‘ç°è¾¹ç•Œæƒ…å†µ
3. **æ¶æ„è®¾è®¡**: åŸºç±»è®¾è®¡æœ‰åŠ©äºç»Ÿä¸€çŠ¶æ€ç®¡ç†
4. **ä»£ç å®¡æŸ¥**: éœ€è¦ä»”ç»†æ£€æŸ¥çŠ¶æ€æ›´æ–°é€»è¾‘

## ç›¸å…³æ–‡ä»¶
- `contracts/core/strategies/StrategySupplyBase.sol` (æ–°å¢åŸºç±»)
- `contracts/core/strategies/StrategySupplyAAVEv3.sol` (é‡æ„)
- `contracts/core/strategies/StrategySupplyMorpho.sol` (ç›¸å…³)
- `contracts/core/strategies/StrategySupplyERC4626.sol` (ç›¸å…³)
