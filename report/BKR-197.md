# BKR-197 åˆ†ææŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯
- **ç¼–å·**: BKR-197
- **æ ‡é¢˜**: decimals conversions There are multiple issues with the decimal conversions between the vault and the strategy - F13
- **å‘ç°æ—¶é—´**: 2025-01-16
- **ä¿®å¤æ—¶é—´**: 2025-01-16 (f99edb1)
- **æ€§è´¨**: **å®‰å…¨æ¼æ´** (é€šè¿‡æ¨¡ç³Šæµ‹è¯•F13å‘ç°)
- **ä¸¥é‡ç¨‹åº¦**: **é«˜** - å½±å“ç²¾åº¦è®¡ç®—å’Œèµ„é‡‘å®‰å…¨

## æ¼æ´æè¿°
BKR-197 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ¶‰åŠé‡‘åº“å’Œç­–ç•¥ä¹‹é—´çš„ç²¾åº¦è½¬æ¢é—®é¢˜ã€‚ç¡¬ç¼–ç çš„18ä½ç²¾åº¦å‡è®¾å¯¼è‡´ä¸åŒç²¾åº¦ä»£å¸ä¹‹é—´çš„è®¡ç®—é”™è¯¯ï¼Œå¯èƒ½é€ æˆèµ„é‡‘æŸå¤±ã€‚

## åœ¨81485a9ä¸­çš„æ¼æ´çŠ¶æ€
### æ¼æ´ä½ç½®
åœ¨ `b-pre-mitigation (81485a9)` ç‰ˆæœ¬ä¸­ï¼Œå­˜åœ¨ä»¥ä¸‹ç²¾åº¦è½¬æ¢é—®é¢˜ï¼š

#### 1. ç¡¬ç¼–ç ç²¾åº¦é—®é¢˜
```solidity
// 81485a9ç‰ˆæœ¬ä¸­çš„æ¼æ´ä»£ç 
uint8 constant SYSTEM_DECIMALS = 18; // âŒ ç¡¬ç¼–ç 18ä½ç²¾åº¦

// StrategySupplyAAVEv3.solä¸­çš„é—®é¢˜
function getBalance() public view virtual returns (uint256) {
  DataTypes.ReserveData memory reserve = (_aavev3.getReserveData(_asset));
  uint8 reserveDecimals = ERC20(reserve.aTokenAddress).decimals();
  uint256 reserveBalance = ERC20(reserve.aTokenAddress).balanceOf(address(this));
  
  // âŒ å¼ºåˆ¶è½¬æ¢ä¸º18ä½ç²¾åº¦
  reserveBalance = reserveBalance.toDecimals(reserveDecimals, SYSTEM_DECIMALS);
  return reserveBalance;
}
```

#### 2. é‡‘åº“ç²¾åº¦å‡è®¾é—®é¢˜
```solidity
// 81485a9ç‰ˆæœ¬ä¸­å‡è®¾æ‰€æœ‰ä»£å¸éƒ½æ˜¯18ä½ç²¾åº¦
uint256 private constant _ONE = 1e18; // âŒ ç¡¬ç¼–ç 18ä½ç²¾åº¦

function tokenPerAsset() public view returns (uint256) {
  uint256 totalAssetsValue = totalAssets();
  
  if (totalSupply() == 0 || totalAssetsValue == 0) {
    return _ONE; // âŒ ä½¿ç”¨ç¡¬ç¼–ç çš„1e18
  }
  
  return (totalSupply() * _ONE) / totalAssetsValue; // âŒ ç²¾åº¦ä¸åŒ¹é…
}
```

### æ¼æ´å½±å“
1. **ç²¾åº¦æŸå¤±**: ä¸åŒç²¾åº¦ä»£å¸ä¹‹é—´çš„è½¬æ¢å¯¼è‡´ç²¾åº¦æŸå¤±
2. **è®¡ç®—é”™è¯¯**: åŸºäºé”™è¯¯ç²¾åº¦çš„è®¡ç®—å¯èƒ½å¯¼è‡´èµ„é‡‘æŸå¤±
3. **ä»£å¸å…¼å®¹æ€§**: ä¸æ”¯æŒé18ä½ç²¾åº¦çš„ä»£å¸ï¼ˆå¦‚USDC 6ä½ç²¾åº¦ï¼‰
4. **çŠ¶æ€ä¸ä¸€è‡´**: é‡‘åº“å’Œç­–ç•¥ä¹‹é—´çš„ç²¾åº¦ä¸åŒ¹é…

### æ¼æ´æ ¹å› 
- **ç¡¬ç¼–ç ç²¾åº¦**: å‡è®¾æ‰€æœ‰ä»£å¸éƒ½æ˜¯18ä½ç²¾åº¦
- **ç¼ºä¹åŠ¨æ€ç²¾åº¦**: æ²¡æœ‰æ ¹æ®å®é™…ä»£å¸ç²¾åº¦è¿›è¡ŒåŠ¨æ€è°ƒæ•´
- **è½¬æ¢é”™è¯¯**: å¼ºåˆ¶è½¬æ¢åˆ°18ä½ç²¾åº¦å¯¼è‡´ç²¾åº¦æŸå¤±

## ä¿®å¤æ–¹æ¡ˆ (f99edb1)
### 1. ç§»é™¤ç¡¬ç¼–ç ç²¾åº¦å¸¸é‡
```solidity
// ä¿®å¤å‰ (81485a9)
uint8 constant SYSTEM_DECIMALS = 18; // âŒ ç¡¬ç¼–ç 

// ä¿®å¤å (f99edb1)
// âœ… ç§»é™¤ç¡¬ç¼–ç å¸¸é‡ï¼Œä½¿ç”¨åŠ¨æ€ç²¾åº¦
```

### 2. åŠ¨æ€ç²¾åº¦è®¡ç®—
```solidity
// ä¿®å¤åçš„VaultBase.sol
function decimals() public view override(ERC20Upgradeable, IERC20MetadataUpgradeable) returns (uint8) {
  return ERC20Upgradeable(_asset()).decimals(); // âœ… åŠ¨æ€è·å–ä»£å¸ç²¾åº¦
}

function _ONE() private view returns (uint256) {
  return 10 ** decimals(); // âœ… åŸºäºå®é™…ç²¾åº¦è®¡ç®—
}

function tokenPerAsset() public view returns (uint256) {
  uint256 totalAssetsValue = totalAssets();
  
  if (totalSupply() == 0 || totalAssetsValue == 0) {
    return _ONE(); // âœ… ä½¿ç”¨åŠ¨æ€ç²¾åº¦
  }
  
  return (totalSupply() * _ONE()) / totalAssetsValue; // âœ… ç²¾åº¦åŒ¹é…
}
```

### 3. ç­–ç•¥ç²¾åº¦ä¿®å¤
```solidity
// ä¿®å¤åçš„StrategySupplyAAVEv3.sol
function _getBalance() internal view virtual override returns (uint256) {
  DataTypes.ReserveData memory reserve = (_aavev3.getReserveData(_asset));
  return ERC20(reserve.aTokenAddress).balanceOf(address(this)); // âœ… ç›´æ¥è¿”å›ï¼Œä¸å¼ºåˆ¶è½¬æ¢
}
```

### 4. æ¶æ„é‡æ„
- **åˆ›å»ºVaultBaseåŸºç±»**: ç»Ÿä¸€ç²¾åº¦å¤„ç†é€»è¾‘
- **ç­–ç•¥åŸºç±»**: StrategySupplyBaseæä¾›ç»Ÿä¸€çš„ç²¾åº¦ç®¡ç†
- **åŠ¨æ€ç²¾åº¦**: æ‰€æœ‰è®¡ç®—åŸºäºå®é™…ä»£å¸ç²¾åº¦

## ä¿®å¤æäº¤è¯¦æƒ…
- **æäº¤å“ˆå¸Œ**: 0a356c2
- **PR**: #24
- **ä½œè€…**: Chef Kenji
- **æ–‡ä»¶å˜æ›´**: 11ä¸ªæ–‡ä»¶ï¼Œ+303è¡Œï¼Œ-33è¡Œ

### æ ¸å¿ƒæ–‡ä»¶å˜æ›´
```
contracts/core/Constants.sol                       | ç§»é™¤SYSTEM_DECIMALS
contracts/core/VaultBase.sol                       | æ·»åŠ åŠ¨æ€ç²¾åº¦æ”¯æŒ
contracts/core/strategies/StrategySupplyAAVEv3.sol | ç§»é™¤å¼ºåˆ¶ç²¾åº¦è½¬æ¢
contracts/core/strategies/StrategyLeverage.sol     | ç²¾åº¦ä¿®å¤
contracts/core/strategies/StrategySwapAnd.sol      | ç²¾åº¦ä¿®å¤
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æ¼æ´åœºæ™¯ç¤ºä¾‹
```solidity
// æ¼æ´åœºæ™¯ï¼šUSDC (6ä½ç²¾åº¦) ä¸ ETH (18ä½ç²¾åº¦) æ··åˆ
// 1. ç”¨æˆ·å­˜å…¥ 1000 USDC (6ä½ç²¾åº¦)
uint256 usdcAmount = 1000 * 10**6; // 1000000000

// 2. é”™è¯¯è½¬æ¢åˆ°18ä½ç²¾åº¦
uint256 convertedAmount = usdcAmount.toDecimals(6, 18); // 1000000000000000000000
// âŒ é”™è¯¯ï¼šå®é™…åº”è¯¥æ˜¯ 1000 USDCï¼Œä½†è¢«è½¬æ¢ä¸º 1000 ETH ç­‰å€¼

// 3. è®¡ç®—é”™è¯¯
uint256 tokenPerAsset = (totalSupply() * 1e18) / totalAssetsValue;
// âŒ åŸºäºé”™è¯¯ç²¾åº¦è®¡ç®—ï¼Œå¯¼è‡´ç”¨æˆ·æŸå¤±
```

### ä¿®å¤åçš„æ­£ç¡®æµç¨‹
```solidity
// ä¿®å¤åçš„æ­£ç¡®æµç¨‹
// 1. ç”¨æˆ·å­˜å…¥ 1000 USDC (6ä½ç²¾åº¦)
uint256 usdcAmount = 1000 * 10**6; // 1000000000

// 2. ä¿æŒåŸå§‹ç²¾åº¦
uint256 balance = ERC20(usdcToken).balanceOf(address(this)); // 1000000000
// âœ… æ­£ç¡®ï¼šä¿æŒUSDCçš„6ä½ç²¾åº¦

// 3. åŸºäºå®é™…ç²¾åº¦è®¡ç®—
uint256 tokenPerAsset = (totalSupply() * 10**decimals()) / totalAssetsValue;
// âœ… æ­£ç¡®ï¼šåŸºäºUSDCçš„6ä½ç²¾åº¦è®¡ç®—
```

## å½±å“è¯„ä¼°
### å®‰å…¨é£é™©
- ğŸ”´ **é«˜ä¸¥é‡æ€§**: å½±å“èµ„é‡‘è®¡ç®—å’Œç”¨æˆ·æ”¶ç›Š
- ğŸ”´ **ç²¾åº¦æŸå¤±**: å¯èƒ½å¯¼è‡´ç”¨æˆ·èµ„é‡‘æŸå¤±
- ğŸ”´ **ä»£å¸å…¼å®¹æ€§**: ä¸æ”¯æŒé18ä½ç²¾åº¦ä»£å¸
- ğŸ”´ **è®¡ç®—é”™è¯¯**: åŸºäºé”™è¯¯ç²¾åº¦çš„æ‰€æœ‰è®¡ç®—

### ä¿®å¤æ•ˆæœ
- âœ… **åŠ¨æ€ç²¾åº¦**: æ”¯æŒä»»æ„ç²¾åº¦çš„ä»£å¸
- âœ… **è®¡ç®—å‡†ç¡®æ€§**: åŸºäºå®é™…ä»£å¸ç²¾åº¦è®¡ç®—
- âœ… **ä»£å¸å…¼å®¹æ€§**: æ”¯æŒUSDCã€USDTç­‰é18ä½ç²¾åº¦ä»£å¸
- âœ… **æ¶æ„ç»Ÿä¸€**: é€šè¿‡åŸºç±»ç»Ÿä¸€ç²¾åº¦å¤„ç†

## æµ‹è¯•éªŒè¯
### æ¨¡ç³Šæµ‹è¯•å‘ç°
- **æµ‹è¯•å·¥å…·**: F13 (æ¨¡ç³Šæµ‹è¯•)
- **å‘ç°æ–¹å¼**: é€šè¿‡ä¸åŒç²¾åº¦ä»£å¸çš„éšæœºæ“ä½œå‘ç°è®¡ç®—é”™è¯¯
- **æµ‹è¯•åœºæ™¯**: æ··åˆç²¾åº¦ä»£å¸çš„å­˜æ¬¾ã€æå–ã€è®¡ç®—æ“ä½œ

### ä¿®å¤éªŒè¯
```solidity
// æµ‹è¯•ç”¨ä¾‹
function testDecimalsConversion() public {
  // 1. æµ‹è¯•USDC (6ä½ç²¾åº¦)
  vault.deposit(1000 * 10**6, user1);
  assertEq(vault.balanceOf(user1), 1000 * 10**6); // âœ… ä¿æŒ6ä½ç²¾åº¦
  
  // 2. æµ‹è¯•ETH (18ä½ç²¾åº¦)
  vault.deposit(1 * 10**18, user2);
  assertEq(vault.balanceOf(user2), 1 * 10**18); // âœ… ä¿æŒ18ä½ç²¾åº¦
  
  // 3. éªŒè¯è®¡ç®—å‡†ç¡®æ€§
  uint256 tokenPerAsset = vault.tokenPerAsset();
  // åº”è¯¥åŸºäºå®é™…ä»£å¸ç²¾åº¦è®¡ç®—ï¼Œè€Œä¸æ˜¯ç¡¬ç¼–ç 18ä½
}
```

## ç»“è®º
BKR-197 æ˜¯ä¸€ä¸ª**ä¸¥é‡çš„å®‰å…¨æ¼æ´**ï¼Œé€šè¿‡æ¨¡ç³Šæµ‹è¯•F13å‘ç°ã€‚å®ƒå½±å“ä¸åŒç²¾åº¦ä»£å¸ä¹‹é—´çš„è®¡ç®—å‡†ç¡®æ€§ï¼Œå¯èƒ½å¯¼è‡´ç”¨æˆ·èµ„é‡‘æŸå¤±ã€‚ä¿®å¤é€šè¿‡ç§»é™¤ç¡¬ç¼–ç ç²¾åº¦å‡è®¾ï¼Œå®ç°åŠ¨æ€ç²¾åº¦è®¡ç®—ï¼Œç¡®ä¿äº†è®¡ç®—çš„å‡†ç¡®æ€§å’Œä»£å¸çš„å…¼å®¹æ€§ã€‚

è¿™ä¸ªæ¼æ´çš„ä¿®å¤ä½“ç°äº†ï¼š
1. **ç²¾åº¦å¤„ç†çš„é‡è¦æ€§**: å¿…é¡»æ­£ç¡®å¤„ç†ä¸åŒç²¾åº¦ä»£å¸
2. **ç¡¬ç¼–ç çš„é£é™©**: é¿å…ç¡¬ç¼–ç å‡è®¾ï¼Œä½¿ç”¨åŠ¨æ€å€¼
3. **æµ‹è¯•çš„ä»·å€¼**: æ¨¡ç³Šæµ‹è¯•èƒ½å¤Ÿå‘ç°è¾¹ç•Œæƒ…å†µ
4. **æ¶æ„è®¾è®¡**: åŸºç±»è®¾è®¡æœ‰åŠ©äºç»Ÿä¸€ç²¾åº¦å¤„ç†

## ç›¸å…³æ–‡ä»¶
- `contracts/core/VaultBase.sol` (åŠ¨æ€ç²¾åº¦æ”¯æŒ)
- `contracts/core/Constants.sol` (ç§»é™¤ç¡¬ç¼–ç å¸¸é‡)
- `contracts/core/strategies/StrategySupplyAAVEv3.sol` (ç²¾åº¦ä¿®å¤)
- `contracts/core/strategies/StrategySupplyBase.sol` (åŸºç±»)
- `contracts/core/strategies/StrategyLeverage.sol` (ç›¸å…³ä¿®å¤)
