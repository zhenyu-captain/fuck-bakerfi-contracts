# BKR-200 åˆ†ææŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯
- **ç¼–å·**: BKR-200
- **æ ‡é¢˜**: Users may encounter losses on assets deposited through StrategySupplyERC4626 - F1
- **å‘ç°æ—¶é—´**: 2025-01-14
- **ä¿®å¤æ—¶é—´**: 2025-01-14 (ce9d853)
- **æ€§è´¨**: **å®‰å…¨æ¼æ´** (é€šè¿‡æ¨¡ç³Šæµ‹è¯•F1å‘ç°)
- **ä¸¥é‡ç¨‹åº¦**: **é«˜** - å½±å“ç”¨æˆ·èµ„äº§å®‰å…¨

## æ¼æ´æè¿°
BKR-200 æ˜¯ä¸€ä¸ªä¸¥é‡çš„å®‰å…¨æ¼æ´ï¼Œæ¶‰åŠé€šè¿‡StrategySupplyERC4626å­˜å…¥èµ„äº§æ—¶ç”¨æˆ·å¯èƒ½é­å—æŸå¤±ã€‚è¯¥æ¼æ´çš„æ ¹å› æ˜¯å¯¹ERC4626æ ‡å‡†çš„ç†è§£é”™è¯¯ï¼Œå¯¼è‡´èµ„äº§æ•°é‡è®¡ç®—é”™è¯¯ã€‚

## Gitè®°å½•åˆ†æ

### æ¼æ´æ—¶é—´çº¿

#### 1. æ¼æ´å­˜åœ¨ç‰ˆæœ¬ (81485a9)
- **æäº¤å“ˆå¸Œ**: `81485a9ac56e1a839afdd35970f6f668792568e0`
- **æäº¤æ—¶é—´**: 2024å¹´11æœˆ26æ—¥ 16:34:40
- **æäº¤ä¿¡æ¯**: `[BKR-178] swapper multiple implementations (#115)`
- **å…³é”®å‘ç°**: åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œ**StrategySupplyERC4626.solæ–‡ä»¶ä¸å­˜åœ¨**
- **çŠ¶æ€**: æ¼æ´å­˜åœ¨ - åŠŸèƒ½ç¼ºå¤±

#### 2. åŠŸèƒ½å¼•å…¥ç‰ˆæœ¬ (dfcf463)
- **æäº¤å“ˆå¸Œ**: `dfcf4631ba93504dcb0f2bd690b63d825b3ede81`
- **æäº¤æ—¶é—´**: 2024å¹´12æœˆ4æ—¥ 16:59:43
- **æäº¤ä¿¡æ¯**: `[BKR-159] Morpho Supply Strategy (#118)`
- **å…³é”®å‘ç°**: åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œ**é¦–æ¬¡åˆ›å»º**äº†StrategySupplyERC4626.solæ–‡ä»¶
- **çŠ¶æ€**: åŠŸèƒ½å¼•å…¥ - ä½†å­˜åœ¨æ¼æ´

#### 3. æ¼æ´ä¿®å¤ç‰ˆæœ¬ (ce9d853)
- **æäº¤å“ˆå¸Œ**: `ce9d853ff1c24840fd02e4e8b352022b8f09c401`
- **æäº¤æ—¶é—´**: 2025å¹´1æœˆ14æ—¥ 10:54:32
- **æäº¤ä¿¡æ¯**: `[BKR-200] Users may encounter losses on assets deposited through StrategySupplyERC4626 - F1 (#17)`
- **å…³é”®å‘ç°**: åœ¨è¿™ä¸ªç‰ˆæœ¬ä¸­ï¼Œ**ä¿®å¤äº†**StrategySupplyERC4626.solä¸­çš„æ¼æ´
- **çŠ¶æ€**: æ¼æ´ä¿®å¤

#### 4. æœ€ç»ˆç‰ˆæœ¬ (f99edb1)
- **æäº¤å“ˆå¸Œ**: `f99edb106340e47530652923c00913dad9462a3b`
- **æäº¤æ—¶é—´**: 2025å¹´2æœˆ5æ—¥ 12:24:28
- **æäº¤ä¿¡æ¯**: `Merge pull request #133 from baker-fi/develop`
- **å…³é”®å‘ç°**: åˆå¹¶äº†æ‰€æœ‰ä¿®å¤çš„æœ€ç»ˆç‰ˆæœ¬
- **çŠ¶æ€**: æœ€ç»ˆä¿®å¤ç‰ˆæœ¬

## æ¼æ´æœºåˆ¶åˆ†æ

### æ¼æ´æ ¹å› 
BKR-200çš„æ¼æ´æ ¹å› æ˜¯**ERC4626æ ‡å‡†ç†è§£é”™è¯¯**ï¼š

1. **é”™è¯¯ç†è§£**: ç›´æ¥ä½¿ç”¨ERC4626çš„sharesæ•°é‡ä½œä¸ºèµ„äº§æ•°é‡
2. **æ­£ç¡®ç†è§£**: åº”è¯¥ä½¿ç”¨`convertToAssets()`å°†sharesè½¬æ¢ä¸ºå®é™…çš„èµ„äº§æ•°é‡
3. **å½±å“**: å¯¼è‡´ç”¨æˆ·å­˜å…¥å’Œæå–çš„èµ„äº§æ•°é‡è®¡ç®—é”™è¯¯ï¼Œå¯èƒ½é€ æˆæŸå¤±

### æ¼æ´ä»£ç åˆ†æ

#### ä¿®å¤å‰çš„ä»£ç  (dfcf463 - æ¼æ´å­˜åœ¨)
```solidity
function _deploy(uint256 amount) internal override returns (uint256) {
  return _vault.deposit(amount, address(this));  // âŒ ç›´æ¥è¿”å›shares
}

function _undeploy(uint256 amount) internal override returns (uint256) {
  return _vault.withdraw(amount, address(this), address(this));  // âŒ ç›´æ¥è¿”å›shares
}

function _getBalance() internal view override returns (uint256) {
  return _vault.balanceOf(address(this));  // âŒ ç›´æ¥è¿”å›shares
}
```

#### ä¿®å¤åçš„ä»£ç  (ce9d853 - æ¼æ´ä¿®å¤)
```solidity
function _deploy(uint256 amount) internal override returns (uint256) {
  return _vault.convertToAssets(_vault.deposit(amount, address(this)));  // âœ… è½¬æ¢ä¸ºassets
}

function _undeploy(uint256 amount) internal override returns (uint256) {
  return _vault.convertToAssets(_vault.withdraw(amount, address(this), address(this)));  // âœ… è½¬æ¢ä¸ºassets
}

function _getBalance() internal view override returns (uint256) {
  return _vault.convertToAssets(_vault.balanceOf(address(this)));  // âœ… è½¬æ¢ä¸ºassets
}
```

### æ¼æ´å½±å“

#### ä¿®å¤å‰çš„å½±å“
1. **èµ„äº§è®¡ç®—é”™è¯¯**: ä½¿ç”¨sharesæ•°é‡è€Œä¸æ˜¯å®é™…èµ„äº§æ•°é‡
2. **ç”¨æˆ·æŸå¤±**: ç”¨æˆ·å­˜å…¥å’Œæå–çš„èµ„äº§æ•°é‡ä¸å‡†ç¡®
3. **çŠ¶æ€ä¸ä¸€è‡´**: ç­–ç•¥è®°å½•çš„èµ„äº§æ•°é‡ä¸å®é™…èµ„äº§æ•°é‡ä¸åŒ¹é…
4. **ä¼šè®¡é”™è¯¯**: å¯èƒ½å¯¼è‡´æ€§èƒ½è´¹ç”¨è®¡ç®—é”™è¯¯

#### ä¿®å¤åçš„æ•ˆæœ
1. **èµ„äº§è®¡ç®—æ­£ç¡®**: ä½¿ç”¨`convertToAssets()`æ­£ç¡®è½¬æ¢sharesä¸ºèµ„äº§
2. **ç”¨æˆ·å®‰å…¨**: ç”¨æˆ·å­˜å…¥å’Œæå–çš„èµ„äº§æ•°é‡å‡†ç¡®
3. **çŠ¶æ€ä¸€è‡´**: ç­–ç•¥è®°å½•çš„èµ„äº§æ•°é‡ä¸å®é™…èµ„äº§æ•°é‡åŒ¹é…
4. **ä¼šè®¡å‡†ç¡®**: æ€§èƒ½è´¹ç”¨è®¡ç®—åŸºäºæ­£ç¡®çš„èµ„äº§æ•°é‡

## æŠ€æœ¯å®ç°ç»†èŠ‚

### ERC4626æ ‡å‡†ç†è§£

#### é”™è¯¯ç†è§£ (æ¼æ´å­˜åœ¨)
```solidity
// âŒ é”™è¯¯: ç›´æ¥ä½¿ç”¨sharesæ•°é‡
uint256 shares = _vault.deposit(amount, address(this));
return shares;  // è¿”å›sharesæ•°é‡ï¼Œä¸æ˜¯èµ„äº§æ•°é‡
```

#### æ­£ç¡®ç†è§£ (æ¼æ´ä¿®å¤)
```solidity
// âœ… æ­£ç¡®: å°†sharesè½¬æ¢ä¸ºèµ„äº§æ•°é‡
uint256 shares = _vault.deposit(amount, address(this));
return _vault.convertToAssets(shares);  // è¿”å›å®é™…èµ„äº§æ•°é‡
```

### æ¼æ´åœºæ™¯ç¤ºä¾‹

```solidity
// æ¼æ´åœºæ™¯ç¤ºä¾‹
// 1. ç”¨æˆ·å­˜å…¥ 1000 USDC
uint256 depositAmount = 1000 * 10**6;  // 1000 USDC (6ä½ç²¾åº¦)

// 2. ERC4626é‡‘åº“è¿”å›shares
uint256 shares = vault.deposit(depositAmount, address(this));
// å‡è®¾è¿”å› 950 shares (ç”±äºè´¹ç”¨æˆ–æ±‡ç‡å˜åŒ–)

// 3. é”™è¯¯å¤„ç† (ä¿®å¤å‰)
return shares;  // âŒ è¿”å› 950ï¼Œä½†å®é™…åº”è¯¥æ˜¯ 1000 USDC

// 4. æ­£ç¡®å¤„ç† (ä¿®å¤å)
return vault.convertToAssets(shares);  // âœ… è¿”å› 1000 USDC
```

## ä¿®å¤æ–¹æ¡ˆ (ce9d853)

### 1. ä¿®å¤_deployå‡½æ•°
```solidity
function _deploy(uint256 amount) internal override returns (uint256) {
  // ä¿®å¤å‰: return _vault.deposit(amount, address(this));
  // ä¿®å¤å:
  return _vault.convertToAssets(_vault.deposit(amount, address(this)));
}
```

### 2. ä¿®å¤_undeployå‡½æ•°
```solidity
function _undeploy(uint256 amount) internal override returns (uint256) {
  // ä¿®å¤å‰: return _vault.withdraw(amount, address(this), address(this));
  // ä¿®å¤å:
  return _vault.convertToAssets(_vault.withdraw(amount, address(this), address(this)));
}
```

### 3. ä¿®å¤_getBalanceå‡½æ•°
```solidity
function _getBalance() internal view override returns (uint256) {
  // ä¿®å¤å‰: return _vault.balanceOf(address(this));
  // ä¿®å¤å:
  return _vault.convertToAssets(_vault.balanceOf(address(this)));
}
```

### 4. æ·»åŠ æµ‹è¯•ç”¨ä¾‹
```typescript
// æ–°å¢æµ‹è¯•æ–‡ä»¶: test/core/strategies/StrategySupplyERC4626.ts
it('Deposit 10 USDC', async function () {
  const { strategySupplyERC4626, usdc, vaultContract } = await loadFixture(deployFunction);
  const deployAmount = ethers.parseEther('10');
  await usdc.approve(await strategySupplyERC4626.getAddress(), deployAmount);
  await strategySupplyERC4626.deploy(deployAmount);
  expect(await strategySupplyERC4626.totalAssets()).to.equal(deployAmount);
  expect(await usdc.balanceOf(await vaultContract.getAddress())).to.equal(deployAmount);
});
```

## ä¿®å¤æäº¤è¯¦æƒ…

### æäº¤ä¿¡æ¯
- **æäº¤å“ˆå¸Œ**: ce9d853ff1c24840fd02e4e8b352022b8f09c401
- **PR**: #17
- **ä½œè€…**: Chef Kenji <chef.kenji@bakerfi.xyz>
- **æ–‡ä»¶å˜æ›´**: 2ä¸ªæ–‡ä»¶ï¼Œ+68è¡Œï¼Œ-3è¡Œ

### å…·ä½“ä¿®å¤
```diff
// contracts/core/strategies/StrategySupplyERC4626.sol
function _deploy(uint256 amount) internal override returns (uint256) {
-  return _vault.deposit(amount, address(this));
+  return _vault.convertToAssets(_vault.deposit(amount, address(this)));
}

function _undeploy(uint256 amount) internal override returns (uint256) {
-  return _vault.withdraw(amount, address(this), address(this));
+  return _vault.convertToAssets(_vault.withdraw(amount, address(this), address(this)));
}

function _getBalance() internal view override returns (uint256) {
-  return _vault.balanceOf(address(this));
+  return _vault.convertToAssets(_vault.balanceOf(address(this)));
}
```

## å½±å“è¯„ä¼°

### å®‰å…¨é£é™©
- ğŸ”´ **é«˜ä¸¥é‡æ€§**: å½±å“ç”¨æˆ·èµ„äº§è®¡ç®—å’Œæå–
- ğŸ”´ **ç”¨æˆ·æŸå¤±**: å¯èƒ½å¯¼è‡´ç”¨æˆ·èµ„äº§æ•°é‡è®¡ç®—é”™è¯¯
- ğŸ”´ **çŠ¶æ€ä¸ä¸€è‡´**: ç­–ç•¥çŠ¶æ€ä¸å®é™…èµ„äº§çŠ¶æ€ä¸åŒ¹é…
- ğŸ”´ **ä¼šè®¡é”™è¯¯**: å½±å“æ€§èƒ½è´¹ç”¨å’Œæ”¶ç›Šè®¡ç®—

### ä¿®å¤æ•ˆæœ
- âœ… **èµ„äº§è®¡ç®—å‡†ç¡®**: æ­£ç¡®ä½¿ç”¨ERC4626æ ‡å‡†
- âœ… **ç”¨æˆ·å®‰å…¨**: ç”¨æˆ·èµ„äº§æ•°é‡è®¡ç®—æ­£ç¡®
- âœ… **çŠ¶æ€ä¸€è‡´**: ç­–ç•¥çŠ¶æ€ä¸å®é™…èµ„äº§çŠ¶æ€åŒ¹é…
- âœ… **ä¼šè®¡å‡†ç¡®**: æ€§èƒ½è´¹ç”¨å’Œæ”¶ç›Šè®¡ç®—æ­£ç¡®

## æµ‹è¯•éªŒè¯

### æ¨¡ç³Šæµ‹è¯•å‘ç°
- **æµ‹è¯•å·¥å…·**: F1 (æ¨¡ç³Šæµ‹è¯•)
- **å‘ç°æ–¹å¼**: é€šè¿‡éšæœºè¾“å…¥å‘ç°èµ„äº§æ•°é‡è®¡ç®—é”™è¯¯
- **æµ‹è¯•åœºæ™¯**: å¤šæ¬¡å­˜å…¥å’Œæå–æ“ä½œ

### ä¿®å¤éªŒè¯
```typescript
// æµ‹è¯•ç”¨ä¾‹
function testDepositWithdraw() public {
  // 1. å­˜å…¥èµ„äº§
  strategy.deploy(1000);
  assertEq(strategy.totalAssets(), 1000); // âœ… ä¿®å¤åé€šè¿‡
  
  // 2. æå–èµ„äº§
  strategy.undeploy(500);
  assertEq(strategy.totalAssets(), 500); // âœ… ä¿®å¤åé€šè¿‡
  
  // 3. éªŒè¯èµ„äº§æ•°é‡è®¡ç®—
  // åº”è¯¥åŸºäºå®é™…èµ„äº§æ•°é‡ï¼Œè€Œä¸æ˜¯sharesæ•°é‡
}
```

## ç»“è®º

BKR-200æ˜¯ä¸€ä¸ª**ERC4626æ ‡å‡†ç†è§£é”™è¯¯å¯¼è‡´çš„å®‰å…¨æ¼æ´**ï¼Œé€šè¿‡æ¨¡ç³Šæµ‹è¯•F1å‘ç°ã€‚è¯¥æ¼æ´å½±å“ç”¨æˆ·èµ„äº§æ•°é‡çš„æ­£ç¡®è®¡ç®—ï¼Œå¯èƒ½å¯¼è‡´ç”¨æˆ·æŸå¤±ã€‚

ä¿®å¤é€šè¿‡æ­£ç¡®ä½¿ç”¨`convertToAssets()`å‡½æ•°å°†ERC4626çš„sharesè½¬æ¢ä¸ºå®é™…èµ„äº§æ•°é‡ï¼Œç¡®ä¿äº†èµ„äº§è®¡ç®—çš„å‡†ç¡®æ€§å’Œç”¨æˆ·çš„å®‰å…¨æ€§ã€‚

è¿™ä¸ªæ¼æ´çš„ä¿®å¤ä½“ç°äº†ï¼š
1. **æ ‡å‡†ç†è§£çš„é‡è¦æ€§**: å¿…é¡»æ­£ç¡®ç†è§£å’Œä½¿ç”¨ERC4626æ ‡å‡†
2. **æµ‹è¯•çš„ä»·å€¼**: æ¨¡ç³Šæµ‹è¯•èƒ½å¤Ÿå‘ç°æ ‡å‡†ä½¿ç”¨é”™è¯¯
3. **ä»£ç å®¡æŸ¥**: éœ€è¦ä»”ç»†æ£€æŸ¥æ ‡å‡†åº“çš„ä½¿ç”¨æ–¹å¼
4. **ç”¨æˆ·å®‰å…¨**: èµ„äº§è®¡ç®—é”™è¯¯ç›´æ¥å½±å“ç”¨æˆ·èµ„é‡‘å®‰å…¨

## ç›¸å…³æ–‡ä»¶
- `contracts/core/strategies/StrategySupplyERC4626.sol` (ä¿®å¤)
- `test/core/strategies/StrategySupplyERC4626.ts` (æ–°å¢æµ‹è¯•)
- `contracts/core/strategies/StrategySupplyBase.sol` (åŸºç±»)
- `contracts/interfaces/core/IStrategy.sol` (æ¥å£)

## æ—¶é—´çº¿æ€»ç»“

| æ—¶é—´ | æäº¤å“ˆå¸Œ | ç‰ˆæœ¬ | çŠ¶æ€ | è¯´æ˜ |
|------|----------|------|------|------|
| 2024-11-26 | 81485a9 | b-pre-mitigation | æ¼æ´å­˜åœ¨ | StrategySupplyERC4626.solä¸å­˜åœ¨ |
| 2024-12-04 | dfcf463 | åŠŸèƒ½å¼•å…¥ | æ¼æ´å­˜åœ¨ | åˆ›å»ºStrategySupplyERC4626.solä½†å­˜åœ¨æ¼æ´ |
| 2025-01-14 | ce9d853 | æ¼æ´ä¿®å¤ | æ¼æ´ä¿®å¤ | ä¿®å¤ERC4626èµ„äº§è½¬æ¢é—®é¢˜ |
| 2025-02-05 | f99edb1 | b-post-mitigation | æœ€ç»ˆç‰ˆæœ¬ | åˆå¹¶æ‰€æœ‰ä¿®å¤çš„æœ€ç»ˆç‰ˆæœ¬ |
